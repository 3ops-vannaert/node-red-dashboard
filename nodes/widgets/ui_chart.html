<script type="text/javascript">
    (function () {
        RED.nodes.registerType('ui-chart', {
            category: RED._('@flowforge/node-red-dashboard/ui-base:ui-base.label.category'),
            color: 'rgb(119, 198, 204)',
            defaults: {
                group: { type: 'ui-group', required: true },
                name: { value: '' },
                label: { value: 'chart' },
                order: { value: Number.MAX_SAFE_INTEGER },
                chartType: { value: 'line' },
                xAxisType: { value: 'time' },
                removeOlder: { value: 1, validate: RED.validators.number(), required: true },
                removeOlderUnit: { value: '3600', required: true },
                removeOlderPoints: { value: '', validate: function (value) { return value === '' || RED.validators.number() } },
                width: {
                    value: 0,
                    validate: function (v) {
                        const width = v || 0
                        const currentGroup = $('#node-input-group').val() || this.group
                        const groupNode = RED.nodes.node(currentGroup)
                        const valid = !groupNode || +width <= +groupNode.width
                        $('#node-input-size').toggleClass('input-error', !valid)
                        return valid
                    }
                },
                height: { value: 0 },
                className: { value: '' }
            },
            inputs: 1,
            outputs: 1,
            inputLabels: function () { return this.chartType },
            outputLabels: ['chart state'],
            icon: 'font-awesome/fa-line-chart',
            align: 'right',
            paletteLabel: 'chart',
            label: function () {
                return this.name || (~this.label.indexOf('{' + '{') ? null : this.label) || this.mode + ' chart'
            },
            labelStyle: function () { return this.name ? 'node_label_italic' : '' },
            oneditprepare: function () {
                $('#node-input-size').elementSizer({
                    width: '#node-input-width',
                    height: '#node-input-height',
                    group: '#node-input-group'
                })

                // use jQuery UI tooltip to convert the plain old title attribute to a nice tooltip
                $('.ui-node-popover-title').tooltip({
                    show: {
                        effect: 'slideDown',
                        delay: 150
                    }
                })

                // set value options for chart's type
                $('#node-input-chartType').typedInput({
                    type: 'chartType',
                    types: [{
                        value: 'line',
                        options: [
                            { value: 'line', label: 'Line' },
                            { value: 'bar', label: 'Bar' },
                            { value: 'scatter', label: 'Scatter' }
                        ]
                    }],
                    typeField: '#node-input-chartTypeType'
                })

                // line    = time, linear, log
                // scatter = time, linear, log
                // bar     = categorical (or just hide)

                // provide options for x-axis type
                $('#node-input-xAxisType').typedInput()

                // handle event when chart's type is changed
                $('#node-input-chartType').on('change', (evt) => {
                    const value = $('#node-input-chartType').typedInput('value')
                    if (value === 'line' || value === 'scatter') {
                        // for line and scatter
                        // types - time, linear
                        $('#node-input-xAxisType').typedInput('types', [{
                            value: 'linear',
                            options: [
                                { value: 'time', label: 'Timescale' },
                                { value: 'linear', label: 'Linear' }
                            ]
                        }])
                        $('#node-input-xAxisType').typedInput('type', 'time')
                    } else {
                        // for bar
                        // types - categorical
                        $('#node-input-xAxisType').typedInput('types', [{
                            value: 'linear',
                            options: [
                                { value: 'category', label: 'Categorical' }
                            ]
                        }])
                        $('#node-input-xAxisType').typedInput('type', 'category')
                    }
                })
            }
        })
    })()
</script>

<script type="text/html" data-template-name="ui-chart">
    <div class="form-row">
        <label for="node-input-group"><i class="fa fa-table"></i> Group</label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row">
        <label><i class="fa fa-object-group"></i> Size</label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label for="node-input-label"><i class="fa fa-i-cursor"></i> Label</label>
        <input type="text" id="node-input-label" data-i18n="[placeholder]ui-chart.label.optionalChartTitle">
    </div>
    <div class="form-row">
        <label for="node-input-className"><i class="fa fa-code"></i> Class</label>
        <div style="display: inline;">
            <input style="width: 70%;" type="text" id="node-input-className" placeholder="Optional CSS class name(s)" style="flex-grow: 1;">
            <a
                data-html="true"
                title="Dynamic Property: Class names can also be set by sending a message to the node with a msg.topic of 'ui-property:class' and a payload containing the class name(s) to be applied. NOTE: classes set at runtime will be applied in addition to any class(es) set in the nodes class field."
                class="red-ui-button ui-node-popover-title"
                style="margin-left: 4px; cursor: help; font-size: 0.625rem; border-radius: 50%; width: 24px; height: 24px; display: inline-flex; justify-content: center; align-items: center;">
                <i style="font-family: ui-serif;">fx</i>
            </a>
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-chartType"><i class="fa fa-bookmark"></i> Type</label>
        <input type="text" id="node-input-chartType">
        <input type="hidden" id="node-input-chartTypeType">
    </div>
    <div class="form-row">
        <label for="node-input-xAxisType" data-i18n="ui-chart.label.xType"></label></label>
        <input type="text" id="node-input-xAxisType">
        <input type="hidden" id="node-input-xAxisTypeType">
    </div>
    <div class="form-row" id="x-axis-show">
        <label for="node-input-removeOlder" data-i18n="ui-chart.label.xLimit"></label>
        <label for="node-input-removeOlder" style="width:auto" data-i18n="ui-chart.label.last"></label>
        <input type="text" id="node-input-removeOlder" style="width:50px;">
        <select id="node-input-removeOlderUnit" style="width:100px;">
            <option value="1" data-i18n="ui-chart.label.seconds"></option>
            <option value="60" data-i18n="ui-chart.label.minutes"></option>
            <option value="3600" data-i18n="ui-chart.label.hours"></option>
            <option value="86400" data-i18n="ui-chart.label.days"></option>
            <option value="604800" data-i18n="ui-chart.label.weeks"></option>
        </select>
        <label for="node-input-removeOlderPoints" style="width:auto; margin-left:10px; margin-right:10px;" data-i18n="ui-chart.label.or"></label>
        <input type="text" id="node-input-removeOlderPoints" style="width:60px;" placeholder="1000">
        <span style="margin-left:5px;" data-i18n="ui-chart.label.points"></span>
    </div>
</script>